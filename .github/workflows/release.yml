name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            ext: ''
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            ext: ''
            cross: true
          - os: darwin
            arch: arm64
            runner: macos-latest
            ext: ''
          - os: darwin
            arch: amd64
            runner: macos-latest
            ext: ''
            cross: true
          - os: windows
            arch: amd64
            runner: windows-latest
            ext: '.exe'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libwebp-dev libsharpyuv-dev libjxl-dev libheif-dev

      - name: Install cross-compiler (Linux ARM64)
        if: matrix.os == 'linux' && matrix.cross == true
        run: |
          sudo dpkg --add-architecture arm64
          cat <<EOF | sudo tee /etc/apt/sources.list.d/arm64-ports.list
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -cs) main restricted universe
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -cs)-updates main restricted universe
          EOF
          sudo apt-get update || true
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libwebp-dev:arm64 libjxl-dev:arm64 libheif-dev:arm64

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install webp jpeg-xl libheif

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-pkg-config mingw-w64-x86_64-libwebp mingw-w64-x86_64-libjxl mingw-w64-x86_64-libheif
          path-type: inherit

      - name: Build (Linux ARM64)
        if: matrix.os == 'linux' && matrix.cross == true
        env:
          CGO_ENABLED: '1'
          CC: aarch64-linux-gnu-gcc
          GOOS: linux
          GOARCH: arm64
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig
        run: |
          VERSION=${GITHUB_REF_NAME}
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-X github.com/DanielTso/pixshift/internal/version.Version=${VERSION} \
                   -X github.com/DanielTso/pixshift/internal/version.Commit=${COMMIT} \
                   -X github.com/DanielTso/pixshift/internal/version.Date=${DATE}"
          go build -ldflags "${LDFLAGS}" -o pixshift-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} ./cmd/pixshift

      - name: Install x86_64 deps (macOS amd64 cross)
        if: matrix.os == 'darwin' && matrix.cross == true
        run: |
          arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          arch -x86_64 /usr/local/bin/brew install webp jpeg-xl libheif

      - name: Build (macOS amd64 cross)
        if: matrix.os == 'darwin' && matrix.cross == true
        env:
          CGO_ENABLED: '1'
          GOARCH: amd64
          CGO_CFLAGS: -arch x86_64
          CGO_LDFLAGS: -arch x86_64
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
        run: |
          VERSION=${GITHUB_REF_NAME}
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-X github.com/DanielTso/pixshift/internal/version.Version=${VERSION} \
                   -X github.com/DanielTso/pixshift/internal/version.Commit=${COMMIT} \
                   -X github.com/DanielTso/pixshift/internal/version.Date=${DATE}"
          go build -ldflags "${LDFLAGS}" -o pixshift-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} ./cmd/pixshift

      - name: Build (Unix native)
        if: runner.os != 'Windows' && matrix.cross != true
        env:
          CGO_ENABLED: '1'
        run: |
          VERSION=${GITHUB_REF_NAME}
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-X github.com/DanielTso/pixshift/internal/version.Version=${VERSION} \
                   -X github.com/DanielTso/pixshift/internal/version.Commit=${COMMIT} \
                   -X github.com/DanielTso/pixshift/internal/version.Date=${DATE}"
          go build -ldflags "${LDFLAGS}" -o pixshift-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} ./cmd/pixshift
        shell: bash

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          export CGO_ENABLED=1
          export CC=gcc
          export PATH="/mingw64/bin:$PATH"
          VERSION=${GITHUB_REF_NAME}
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-X github.com/DanielTso/pixshift/internal/version.Version=${VERSION} \
                   -X github.com/DanielTso/pixshift/internal/version.Commit=${COMMIT} \
                   -X github.com/DanielTso/pixshift/internal/version.Date=${DATE}"
          go build -ldflags "${LDFLAGS}" -o pixshift-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} ./cmd/pixshift

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pixshift-${{ matrix.os }}-${{ matrix.arch }}
          path: pixshift-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}

  package:
    name: Package (${{ matrix.format }}-${{ matrix.arch }})
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            nfpm_arch: amd64
            rpm_arch: x86_64
            format: deb
          - arch: amd64
            nfpm_arch: amd64
            rpm_arch: x86_64
            format: rpm
          - arch: arm64
            nfpm_arch: arm64
            rpm_arch: aarch64
            format: deb
          - arch: arm64
            nfpm_arch: arm64
            rpm_arch: aarch64
            format: rpm
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: pixshift-linux-${{ matrix.arch }}

      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      - name: Set version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Rename binary
        run: mv pixshift-linux-${{ matrix.arch }} pixshift && chmod +x pixshift

      - name: Compress man page
        run: gzip -kf pixshift.1

      - name: Build package
        run: |
          if [ "${{ matrix.format }}" = "rpm" ]; then
            ARCH=${{ matrix.rpm_arch }}
          else
            ARCH=${{ matrix.nfpm_arch }}
          fi
          VERSION=${{ steps.version.outputs.version }} ARCH=${ARCH} nfpm package --packager ${{ matrix.format }}

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: pixshift-${{ matrix.format }}-${{ matrix.arch }}
          path: pixshift*.${{ matrix.format }}

  release:
    name: Create Release
    needs: [build, package]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Generate checksums
        run: |
          cd artifacts
          find . -type f -exec sha256sum {} \; | sed 's|./[^/]*/||' > checksums.txt
          mv checksums.txt ../
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*
            checksums.txt
          generate_release_notes: true
